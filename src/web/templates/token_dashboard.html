{% extends "base.html" %}

{% block title %}Token Count Dashboard{% endblock %}

{% block content %}
<div class="card">
    <h2>ðŸ“Š Token Count Dashboard</h2>
    <p>Analysis of token counts across {{ token_data|length }} files using Gemini API.</p>
    
    <div class="stats">
        <div class="stat">
            <div class="stat-value">{{ total_tokens|format_number }}</div>
            <div class="stat-label">Total Tokens</div>
        </div>
        <div class="stat">
            <div class="stat-value">{{ token_data|length }}</div>
            <div class="stat-label">Files Analyzed</div>
        </div>
        <div class="stat">
            <div class="stat-value">{{ avg_tokens|round|int|format_number }}</div>
            <div class="stat-label">Avg Tokens/File</div>
        </div>
        <div class="stat">
            <div class="stat-value">{{ max_tokens|format_number }}</div>
            <div class="stat-label">Max Tokens</div>
        </div>
    </div>
    
    <div style="margin-top: 30px;">
        <h3>Token Distribution by File Type</h3>
        <div id="fileTypeChart" style="height: 300px;"></div>
    </div>
    
    <div style="margin-top: 30px;">
        <h3>Top 10 Files by Token Count</h3>
        <div class="file-list">
            {% for file in top_files %}
            <div class="file-item">
                <span class="file-name">
                    <a href="/file/{{ file.path }}">{{ file.path }}</a>
                </span>
                <span class="file-meta">{{ file.tokens|format_number }} tokens â€¢ {{ file.file_type.upper() }}</span>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <div style="margin-top: 30px;">
        <h3>Token Distribution by Category</h3>
        <div id="categoryChart" style="height: 300px;"></div>
    </div>
</div>

<!-- Load Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Parse the JSON data from Jinja2 templates
    const fileTypeLabels = JSON.parse('{{ file_type_labels|tojson|safe }}');
    const fileTypeValues = JSON.parse('{{ file_type_values|tojson|safe }}');
    const categoryLabels = JSON.parse('{{ category_labels|tojson|safe }}');
    const categoryValues = JSON.parse('{{ category_values|tojson|safe }}');

    // File type chart
    const fileTypeCtx = document.getElementById('fileTypeChart').getContext('2d');
    new Chart(fileTypeCtx, {
        type: 'pie',
        data: {
            labels: fileTypeLabels,
            datasets: [{
                data: fileTypeValues,
                backgroundColor: [
                    '#1877f2', '#42b72a', '#f02849', '#ff7600', '#621a75',
                    '#20cef5', '#0bd986', '#f7b928', '#ff5c8d', '#6c5ce7'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right'
                }
            }
        }
    });
    
    // Category chart
    const categoryCtx = document.getElementById('categoryChart').getContext('2d');
    new Chart(categoryCtx, {
        type: 'bar',
        data: {
            labels: categoryLabels,
            datasets: [{
                label: 'Total Tokens',
                data: categoryValues,
                backgroundColor: '#1877f2',
                borderColor: '#166fe5',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
});
</script>
{% endblock %}
